# 数据库设计文档

## 概述

本文档描述了智能体系统的数据库设计，包括表结构、关系设计、索引策略等。

## 数据库选择

**数据库类型**: MySQL 8.0+  
**字符集**: utf8mb4  
**排序规则**: utf8mb4_unicode_ci  
**存储引擎**: InnoDB  

### 选择理由
1. **成熟稳定**: MySQL 是经过验证的数据库系统
2. **JSON 支持**: 支持 JSON 字段类型，适合存储灵活的元数据
3. **关系型特性**: 支持复杂的关系查询，适合知识图谱结构
4. **生态系统**: 丰富的工具和库支持

## 表结构设计

### 1. 任务表 (task)

**功能**: 存储智能体的任务分解与执行信息

```sql
CREATE TABLE `task` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '任务ID',
    `conversation_id` BIGINT NOT NULL COMMENT '会话ID',
    `parent_task_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '父任务ID（自引用）', 
    `task_type` VARCHAR(50) NOT NULL COMMENT '任务类型：plan/execute/reflect/tool_call',
    `description` TEXT NOT NULL COMMENT '任务描述',
    `status` VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '状态：pending/running/completed/failed/cancelled',
    `priority` INT DEFAULT 0 COMMENT '优先级（数值越大优先级越高）',
    `dependencies` JSON DEFAULT NULL COMMENT '依赖任务ID列表 [1, 2, 3]',        
    `result` TEXT DEFAULT NULL COMMENT '执行结果',
    `error_message` TEXT DEFAULT NULL COMMENT '错误信息（失败时）',
    `retry_count` INT DEFAULT 0 COMMENT '重试次数',
    `metadata` JSON DEFAULT NULL COMMENT '元数据（工具参数、执行上下文等）',    
    `started_at` DATETIME DEFAULT NULL COMMENT '开始执行时间',
    `completed_at` DATETIME DEFAULT NULL COMMENT '完成时间',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_conversation_id` (`conversation_id`),
    KEY `idx_parent_task_id` (`parent_task_id`),
    KEY `idx_status` (`status`),
    KEY `idx_priority` (`priority`),
    KEY `idx_created_at` (`created_at`),
    CONSTRAINT `fk_task_conversation` FOREIGN KEY (`conversation_id`)
        REFERENCES `conversation` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_task_parent` FOREIGN KEY (`parent_task_id`)
        REFERENCES `task` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='任务表';
```

#### 字段说明
- **id**: 主键，自增长
- **conversation_id**: 外键，关联会话表
- **parent_task_id**: 自引用外键，支持任务层次结构
- **task_type**: 任务类型，支持 plan/execute/reflect/tool_call
- **status**: 任务状态，支持 pending/running/completed/failed/cancelled
- **dependencies**: JSON 数组，存储依赖任务ID列表
- **metadata**: JSON 对象，存储任务参数和上下文

#### 索引策略
- 主键索引：`id`
- 外键索引：`conversation_id`, `parent_task_id`
- 查询索引：`status`, `priority`, `created_at`

### 2. 记忆存储表 (memory_store)

**功能**: 存储智能体的各种类型记忆

```sql
CREATE TABLE `memory_store` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '记忆ID',
    `conversation_id` BIGINT NOT NULL COMMENT '会话ID',
    `memory_type` VARCHAR(20) NOT NULL COMMENT '记忆类型：short_term/long_term/episodic/semantic',
    `content` TEXT NOT NULL COMMENT '记忆内容',
    `embedding` BLOB DEFAULT NULL COMMENT '向量嵌入（用于语义检索）',
    `importance_score` FLOAT DEFAULT 0 COMMENT '重要性评分（0-1）',
    `access_count` INT DEFAULT 0 COMMENT '访问次数',
    `last_accessed_at` DATETIME DEFAULT NULL COMMENT '最后访问时间',
    `expires_at` DATETIME DEFAULT NULL COMMENT '过期时间（短期记忆）',
    `metadata` JSON DEFAULT NULL COMMENT '元数据（来源、关联实体等）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_conversation_memory` (`conversation_id`, `memory_type`),
    KEY `idx_importance` (`importance_score`),
    CONSTRAINT `fk_memory_conversation` FOREIGN KEY (`conversation_id`)
        REFERENCES `conversation` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='记忆存储表';
```

#### 字段说明
- **memory_type**: 记忆类型，支持 short_term/long_term/episodic/semantic
- **embedding**: BLOB 字段，存储向量嵌入数据
- **importance_score**: 重要性评分，用于记忆管理
- **expires_at**: 过期时间，支持短期记忆自动清理

#### 索引策略
- 主键索引：`id`
- 外键索引：`conversation_id`
- 复合索引：`(conversation_id, memory_type)`
- 查询索引：`importance_score`

### 3. 知识图谱实体表 (knowledge_graph)

**功能**: 存储知识图谱中的实体信息

```sql
CREATE TABLE `knowledge_graph` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '实体ID',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `entity_type` VARCHAR(50) NOT NULL COMMENT '实体类型：person/product/order/concept',
    `entity_name` VARCHAR(200) NOT NULL COMMENT '实体名称',
    `properties` JSON DEFAULT NULL COMMENT '实体属性（键值对）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_entity` (`user_id`, `entity_type`),
    KEY `idx_entity_name` (`entity_name`),
    KEY `idx_created_at` (`created_at`),
    CONSTRAINT `fk_kg_user` FOREIGN KEY (`user_id`)
        REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识图谱实体表';
```

#### 字段说明
- **entity_type**: 实体类型，支持 person/product/order/concept
- **entity_name**: 实体名称，支持搜索
- **properties**: JSON 对象，存储实体属性

#### 索引策略
- 主键索引：`id`
- 外键索引：`user_id`
- 复合索引：`(user_id, entity_type)`
- 搜索索引：`entity_name`, `created_at`

### 4. 知识图谱关系表 (knowledge_relation)

**功能**: 存储知识图谱中实体间的关系

```sql
CREATE TABLE `knowledge_relation` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '关系ID',
    `from_entity_id` BIGINT UNSIGNED NOT NULL COMMENT '起始实体ID',
    `to_entity_id` BIGINT UNSIGNED NOT NULL COMMENT '目标实体ID',
    `relation_type` VARCHAR(50) NOT NULL COMMENT '关系类型：owns/likes/related_to/depends_on',
    `weight` FLOAT DEFAULT 1.0 COMMENT '关系权重（0-1）',
    `properties` JSON DEFAULT NULL COMMENT '关系属性',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_from_entity` (`from_entity_id`),
    KEY `idx_to_entity` (`to_entity_id`),
    KEY `idx_relation_type` (`relation_type`),
    KEY `idx_created_at` (`created_at`),
    CONSTRAINT `fk_kr_from` FOREIGN KEY (`from_entity_id`) 
        REFERENCES `knowledge_graph` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_kr_to` FOREIGN KEY (`to_entity_id`) 
        REFERENCES `knowledge_graph` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识图谱关系表';
```

#### 字段说明
- **from_entity_id**: 起始实体ID
- **to_entity_id**: 目标实体ID
- **relation_type**: 关系类型，支持 owns/likes/related_to/depends_on
- **weight**: 关系权重，用于图算法

#### 索引策略
- 主键索引：`id`
- 外键索引：`from_entity_id`, `to_entity_id`
- 查询索引：`relation_type`, `created_at`

## 关系设计

### 外键关系
1. **task.conversation_id** → **conversation.id**
2. **task.parent_task_id** → **task.id** (自引用)
3. **memory_store.conversation_id** → **conversation.id**
4. **knowledge_graph.user_id** → **user.id**
5. **knowledge_relation.from_entity_id** → **knowledge_graph.id**
6. **knowledge_relation.to_entity_id** → **knowledge_graph.id**

### 级联删除策略
- 删除会话时，级联删除相关任务和记忆
- 删除用户时，级联删除相关知识实体
- 删除知识实体时，级联删除相关关系
- 删除父任务时，级联删除子任务

## 性能优化

### 索引设计原则
1. **主键索引**: 所有表都有自增主键
2. **外键索引**: 所有外键字段都创建索引
3. **查询索引**: 为常用查询字段创建索引
4. **复合索引**: 为多字段查询创建复合索引

### 查询优化
1. **分页查询**: 所有列表查询都支持分页
2. **条件过滤**: 支持多条件组合查询
3. **排序优化**: 为排序字段创建索引
4. **JSON 查询**: 利用 MySQL 的 JSON 函数

### 存储优化
1. **数据类型**: 选择合适的数据类型
2. **字段长度**: 合理设置 VARCHAR 长度
3. **NULL 值**: 合理使用 NULL 值
4. **JSON 字段**: 合理使用 JSON 字段存储灵活数据

## 数据完整性

### 约束设计
1. **主键约束**: 所有表都有主键
2. **外键约束**: 维护引用完整性
3. **唯一约束**: 防止重复数据
4. **检查约束**: 验证数据范围

### 数据验证
1. **字段长度**: 限制字符串长度
2. **数值范围**: 限制数值范围
3. **枚举值**: 限制枚举值选择
4. **JSON 格式**: 验证 JSON 格式

## 扩展性设计

### 水平扩展
1. **分库分表**: 支持按用户或时间分表
2. **读写分离**: 支持主从复制
3. **连接池**: 使用连接池管理连接

### 垂直扩展
1. **字段扩展**: 使用 JSON 字段存储扩展属性
2. **表扩展**: 支持新增表结构
3. **索引扩展**: 支持新增索引

## 备份和恢复

### 备份策略
1. **全量备份**: 定期全量备份
2. **增量备份**: 定期增量备份
3. **日志备份**: 备份二进制日志

### 恢复策略
1. **点恢复**: 支持恢复到指定时间点
2. **表恢复**: 支持单表恢复
3. **数据恢复**: 支持数据恢复

## 监控和维护

### 性能监控
1. **慢查询**: 监控慢查询
2. **连接数**: 监控连接数
3. **锁等待**: 监控锁等待

### 维护任务
1. **索引维护**: 定期重建索引
2. **统计信息**: 更新统计信息
3. **碎片整理**: 定期整理碎片

---

**最后更新**: 2025-10-19  
**更新人**: AI Assistant  
**版本**: v0.1.0