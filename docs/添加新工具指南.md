# æ·»åŠ æ–°å·¥å…·æŒ‡å—

> å¦‚ä½•ä¸º Agent æ·»åŠ æ–°çš„å·¥å…·èƒ½åŠ›

---

## ğŸ“‹ ç›®å½•ç»“æ„

### å·¥å…·æ–‡ä»¶æ”¾åœ¨å“ªé‡Œï¼Ÿ

```
app/tools/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ base.py                    # å·¥å…·åŸºç±»ï¼ˆä¸è¦ä¿®æ”¹ï¼‰
â”œâ”€â”€ manager.py                 # å·¥å…·ç®¡ç†å™¨ï¼ˆä¸è¦ä¿®æ”¹ï¼‰
â”œâ”€â”€ database/                  # æ•°æ®åº“ç›¸å…³å·¥å…·
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ mysql_tool.py         # MySQL æŸ¥è¯¢å·¥å…·ï¼ˆå‚è€ƒç¤ºä¾‹ï¼‰
â”œâ”€â”€ file/                      # æ–‡ä»¶æ“ä½œå·¥å…·ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ file_read_tool.py     # æ–‡ä»¶è¯»å–å·¥å…·ï¼ˆç¤ºä¾‹ï¼‰
â”œâ”€â”€ system/                    # ç³»ç»Ÿå·¥å…·ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ powershell_tool.py    # PowerShell å·¥å…·ï¼ˆç¤ºä¾‹ï¼‰
â””â”€â”€ web/                       # Web ç›¸å…³å·¥å…·ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ __init__.py
    â””â”€â”€ http_tool.py          # HTTP è¯·æ±‚å·¥å…·ï¼ˆç¤ºä¾‹ï¼‰
```

**è§„åˆ™**ï¼š
- âœ… æŒ‰åŠŸèƒ½åˆ†ç±»åˆ›å»ºå­ç›®å½•ï¼ˆdatabaseã€fileã€systemã€web ç­‰ï¼‰
- âœ… æ¯ä¸ªå·¥å…·ä¸€ä¸ªç‹¬ç«‹çš„ .py æ–‡ä»¶
- âœ… æ–‡ä»¶åä½¿ç”¨ `xxx_tool.py` æ ¼å¼

---

## ğŸ”§ æ·»åŠ æ–°å·¥å…·çš„4ä¸ªæ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºå·¥å…·æ–‡ä»¶

**ä½ç½®**ï¼š`app/tools/ä½ çš„åˆ†ç±»/xxx_tool.py`

**æ¨¡æ¿**ï¼š

```python
"""
æ–‡ä»¶å: xxx_tool.py
åŠŸèƒ½: å·¥å…·åŠŸèƒ½æè¿°
"""

from typing import Type
from pydantic import BaseModel, Field

from app.tools.base import AgentTool, ToolInput
from app.utils.logger import get_logger

logger = get_logger(__name__)


# 1. å®šä¹‰å·¥å…·è¾“å…¥ï¼ˆå‚æ•°ï¼‰
class XxxToolInput(ToolInput):
    """
    å·¥å…·è¾“å…¥å‚æ•°
    
    å­—æ®µï¼š
        param1 (str): å‚æ•°1çš„è¯´æ˜
        param2 (int): å‚æ•°2çš„è¯´æ˜ï¼ˆå¯é€‰ï¼‰
    """
    param1: str = Field(..., description="å‚æ•°1çš„è¯´æ˜")
    param2: int = Field(default=10, description="å‚æ•°2çš„è¯´æ˜")


# 2. å®ç°å·¥å…·ç±»
class XxxTool(AgentTool):
    """
    å·¥å…·åç§°
    
    åŠŸèƒ½ï¼š
    - åŠŸèƒ½ç‚¹1
    - åŠŸèƒ½ç‚¹2
    
    ä½¿ç”¨åœºæ™¯ï¼š
    - åœºæ™¯1
    - åœºæ™¯2
    """
    
    # å·¥å…·åç§°ï¼ˆå¿…é¡»ï¼‰ï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿
    name: str = "xxx_tool"
    
    # å·¥å…·æè¿°ï¼ˆå¿…é¡»ï¼‰ï¼šè¯¦ç»†æè¿°å·¥å…·ç”¨é€”ï¼ŒAgentä¼šæ ¹æ®è¿™ä¸ªå†³å®šæ˜¯å¦è°ƒç”¨
    description: str = """
    ç®€çŸ­æè¿°å·¥å…·çš„åŠŸèƒ½å’Œç”¨é€”ã€‚
    
    ä½¿ç”¨åœºæ™¯ï¼š
    - ä½•æ—¶ä½¿ç”¨è¿™ä¸ªå·¥å…·
    - å·¥å…·èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜
    
    é™åˆ¶ï¼š
    - å·¥å…·çš„é™åˆ¶å’Œçº¦æŸ
    
    ç¤ºä¾‹ï¼š
    - ç¤ºä¾‹ç”¨æ³•1
    - ç¤ºä¾‹ç”¨æ³•2
    """
    
    # å‚æ•° Schemaï¼ˆå¿…é¡»ï¼‰
    args_schema: Type[BaseModel] = XxxToolInput
    
    def __init__(self):
        """åˆå§‹åŒ–å·¥å…·"""
        super().__init__()
        # åœ¨è¿™é‡Œåˆå§‹åŒ–å·¥å…·æ‰€éœ€çš„èµ„æº
        # ä¾‹å¦‚ï¼šæ•°æ®åº“è¿æ¥ã€API å®¢æˆ·ç«¯ç­‰
    
    def execute(self, param1: str, param2: int = 10):
        """
        å·¥å…·æ‰§è¡Œé€»è¾‘ï¼ˆå¿…é¡»å®ç°ï¼‰
        
        å‚æ•°ï¼š
            param1 (str): å‚æ•°1
            param2 (int): å‚æ•°2
        
        è¿”å›ï¼š
            è¿”å›ç»“æœï¼ˆå¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼‰
        
        å¼‚å¸¸ï¼š
            å¦‚æœæ‰§è¡Œå¤±è´¥ï¼ŒæŠ›å‡º ToolExecutionError
        """
        try:
            # å®ç°å·¥å…·é€»è¾‘
            result = f"æ‰§è¡Œç»“æœï¼š{param1}, {param2}"
            
            # è¿”å›ç»“æœ
            return {
                "success": True,
                "data": result,
                "message": "æ‰§è¡ŒæˆåŠŸ"
            }
            
        except Exception as e:
            # å¼‚å¸¸ä¼šè¢«åŸºç±»è‡ªåŠ¨æ•è·å¹¶åŒ…è£…ä¸º ToolExecutionError
            raise e
```

---

### æ­¥éª¤2ï¼šæ³¨å†Œå·¥å…·

**ä½ç½®**ï¼š`app/api/v1/chat.py`ï¼ˆæˆ–åˆ›å»ºç»Ÿä¸€çš„å·¥å…·åˆå§‹åŒ–æ–‡ä»¶ï¼‰

**æ–¹æ³•1ï¼šåœ¨ chat.py ä¸­æ³¨å†Œ**ï¼ˆå½“å‰æ–¹å¼ï¼‰ï¼š

```python
# app/api/v1/chat.py

from app.tools.manager import tool_manager
from app.tools.database.mysql_tool import MySQLQueryTool
from app.tools.file.file_read_tool import FileReadTool  # â† å¯¼å…¥æ–°å·¥å…·

# æ³¨å†Œå·¥å…·ï¼ˆåœ¨è·¯ç”±å®šä¹‰ä¹‹å‰ï¼‰
try:
    # ç°æœ‰å·¥å…·
    tool_manager.register_tool(MySQLQueryTool())
    
    # â­ æ³¨å†Œæ–°å·¥å…·
    tool_manager.register_tool(FileReadTool())
    
    logger.info("å·¥å…·æ³¨å†Œå®Œæˆ", tool_count=len(tool_manager))
except Exception as e:
    logger.warning("å·¥å…·æ³¨å†Œå¤±è´¥æˆ–å·²æ³¨å†Œ", error=str(e))
```

**æ–¹æ³•2ï¼šåˆ›å»ºç»Ÿä¸€çš„å·¥å…·åˆå§‹åŒ–æ–‡ä»¶**ï¼ˆæ¨èï¼‰ï¼š

```python
# app/tools/registry.py

from app.tools.manager import tool_manager
from app.tools.database.mysql_tool import MySQLQueryTool
from app.tools.file.file_read_tool import FileReadTool
from app.tools.system.powershell_tool import PowerShellTool
from app.utils.logger import get_logger

logger = get_logger(__name__)


def register_all_tools():
    """æ³¨å†Œæ‰€æœ‰å·¥å…·"""
    tools = [
        MySQLQueryTool(),
        FileReadTool(),
        PowerShellTool(),
        # ... åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šå·¥å…·
    ]
    
    for tool in tools:
        try:
            tool_manager.register_tool(tool)
            logger.info(f"å·¥å…·æ³¨å†ŒæˆåŠŸ: {tool.name}")
        except Exception as e:
            logger.warning(f"å·¥å…·æ³¨å†Œå¤±è´¥: {tool.name}", error=str(e))
    
    logger.info(f"æ€»è®¡æ³¨å†Œäº† {len(tool_manager)} ä¸ªå·¥å…·")


# åœ¨ chat.py ä¸­è°ƒç”¨ï¼š
# from app.tools.registry import register_all_tools
# register_all_tools()
```

---

### æ­¥éª¤3ï¼šæµ‹è¯•å·¥å…·

**åˆ›å»ºæµ‹è¯•è„šæœ¬**ï¼š`scripts/test_your_tool.py`

```python
import sys
import io
from pathlib import Path

# è®¾ç½®ç¼–ç 
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from app.tools.file.file_read_tool import FileReadTool


def test_file_read_tool():
    """æµ‹è¯•æ–‡ä»¶è¯»å–å·¥å…·"""
    print("\n========== æµ‹è¯•æ–‡ä»¶è¯»å–å·¥å…· ==========")
    
    tool = FileReadTool()
    
    # æµ‹è¯•è¯»å–æ–‡ä»¶
    result = tool.execute(path="README.md")
    print(f"  âœ“ æ–‡ä»¶è¯»å–æˆåŠŸ: {len(result)} å­—ç¬¦")
    
    print("\nâœ“ æ–‡ä»¶è¯»å–å·¥å…·æµ‹è¯•é€šè¿‡")


if __name__ == "__main__":
    test_file_read_tool()
```

---

### æ­¥éª¤4ï¼šé‡å¯æœåŠ¡

**å¦‚æœä½¿ç”¨ reload æ¨¡å¼**ï¼š
- æœåŠ¡ä¼šè‡ªåŠ¨é‡å¯ï¼ˆæ— éœ€æ‰‹åŠ¨ï¼‰

**å¦‚æœæ‰‹åŠ¨å¯åŠ¨**ï¼š
```bash
# åœæ­¢æ—§æœåŠ¡
Get-Job | Stop-Job

# é‡æ–°å¯åŠ¨
python scripts/run_dev.py
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å·¥å…·å‘½åè§„èŒƒ

- âœ… **name**: å°å†™å­—æ¯ + ä¸‹åˆ’çº¿ï¼ˆä¾‹å¦‚ï¼š`file_read`ã€`mysql_query`ï¼‰
- âŒ **ä¸è¦ç”¨**ï¼šé©¼å³°å‘½åã€å¤§å†™å­—æ¯ã€ä¸­æ–‡

**ç¤ºä¾‹**ï¼š
```python
âœ… name = "file_read"
âœ… name = "http_request"
âŒ name = "FileRead"
âŒ name = "æ–‡ä»¶è¯»å–"
```

### 2. å·¥å…·æè¿°è¦è¯¦ç»†

Agent æ ¹æ® `description` å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·ï¼Œæ‰€ä»¥è¦å†™æ¸…æ¥šï¼š

```python
âœ… å¥½çš„æè¿°ï¼š
description = """
è¯»å–æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å†…å®¹ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
- éœ€è¦æŸ¥çœ‹æ–‡ä»¶å†…å®¹æ—¶
- åˆ†ææ–‡æœ¬æ–‡ä»¶æ—¶
- è¯»å–é…ç½®æ–‡ä»¶æ—¶

é™åˆ¶ï¼š
- ä»…æ”¯æŒæ–‡æœ¬æ–‡ä»¶
- æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB

ç¤ºä¾‹ï¼š
- è¯»å– README.md
- è¯»å–é…ç½®æ–‡ä»¶
"""

âŒ ä¸å¥½çš„æè¿°ï¼š
description = "è¯»å–æ–‡ä»¶"  # å¤ªç®€å•ï¼ŒAgent éš¾ä»¥åˆ¤æ–­
```

### 3. å‚æ•°è¯´æ˜è¦æ¸…æ™°

```python
âœ… å¥½çš„å‚æ•°å®šä¹‰ï¼š
class FileReadInput(ToolInput):
    path: str = Field(..., description="æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„")
    encoding: str = Field(default="utf-8", description="æ–‡ä»¶ç¼–ç ï¼Œé»˜è®¤ utf-8")

âŒ ä¸å¥½çš„å‚æ•°å®šä¹‰ï¼š
class FileReadInput(ToolInput):
    path: str  # æ²¡æœ‰ descriptionï¼ŒAgent ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨
```

### 4. å®‰å…¨æ£€æŸ¥å¾ˆé‡è¦

```python
def execute(self, path: str):
    # âœ… æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§
    if '..' in path or path.startswith('/'):
        raise ToolExecutionError("ä¸å®‰å…¨çš„è·¯å¾„")
    
    # âœ… æ£€æŸ¥æ–‡ä»¶å¤§å°
    if os.path.getsize(path) > 10 * 1024 * 1024:  # 10MB
        raise ToolExecutionError("æ–‡ä»¶è¿‡å¤§")
    
    # æ‰§è¡Œæ“ä½œ
    with open(path, 'r') as f:
        return f.read()
```

### 5. è¿”å›æ ¼å¼è¦ç»Ÿä¸€

å»ºè®®è¿”å›å­—å…¸æ ¼å¼ï¼š
```python
return {
    "success": True,
    "data": å®é™…æ•°æ®,
    "message": "æ“ä½œæˆåŠŸçš„è¯´æ˜"
}
```

### 6. æ—¥å¿—è®°å½•

```python
def execute(self, **kwargs):
    # âœ… è®°å½•å…³é”®ä¿¡æ¯
    logger.info("å·¥å…·å¼€å§‹æ‰§è¡Œ", params=kwargs)
    
    result = # ... æ‰§è¡Œé€»è¾‘
    
    logger.info("å·¥å…·æ‰§è¡ŒæˆåŠŸ", result_size=len(result))
    
    return result
```

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ï¼šæ–‡ä»¶è¯»å–å·¥å…·

### åˆ›å»ºæ–‡ä»¶ï¼š`app/tools/file/file_read_tool.py`

```python
"""
æ–‡ä»¶å: file_read_tool.py
åŠŸèƒ½: æ–‡ä»¶è¯»å–å·¥å…·
"""

import os
from typing import Type
from pathlib import Path

from pydantic import BaseModel, Field

from app.tools.base import AgentTool, ToolInput
from app.utils.logger import get_logger
from app.utils.exceptions import ToolExecutionError

logger = get_logger(__name__)


class FileReadInput(ToolInput):
    """æ–‡ä»¶è¯»å–è¾“å…¥å‚æ•°"""
    path: str = Field(..., description="æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰")
    encoding: str = Field(default="utf-8", description="æ–‡ä»¶ç¼–ç ï¼Œé»˜è®¤ utf-8")


class FileReadTool(AgentTool):
    """
    æ–‡ä»¶è¯»å–å·¥å…·
    
    åŠŸèƒ½ï¼š
    - è¯»å–æ–‡æœ¬æ–‡ä»¶å†…å®¹
    - æ”¯æŒå¤šç§ç¼–ç 
    - é™åˆ¶æ–‡ä»¶å¤§å°
    """
    
    name: str = "file_read"
    description: str = """è¯»å–æ–‡ä»¶å†…å®¹ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
- éœ€è¦æŸ¥çœ‹æ–‡ä»¶å†…å®¹æ—¶
- åˆ†ææ–‡æœ¬æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶æ—¶
- è¯»å–é¡¹ç›®ä¸­çš„æ–‡æ¡£

é™åˆ¶ï¼š
- ä»…æ”¯æŒæ–‡æœ¬æ–‡ä»¶ï¼ˆ.txt, .md, .py, .json, .yaml ç­‰ï¼‰
- æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB
- ä»…èƒ½è¯»å–é¡¹ç›®ç›®å½•ä¸‹çš„æ–‡ä»¶

ç¤ºä¾‹ï¼š
- è¯»å– README.md
- è¯»å–é…ç½®æ–‡ä»¶ config/config.yaml
- è¯»å–æ—¥å¿—æ–‡ä»¶ logs/app.log
"""
    args_schema: Type[BaseModel] = FileReadInput
    
    def __init__(self):
        """åˆå§‹åŒ–å·¥å…·"""
        super().__init__()
        # é¡¹ç›®æ ¹ç›®å½•
        self.project_root = Path(__file__).parent.parent.parent.parent
        self.max_file_size = 10 * 1024 * 1024  # 10MB
    
    def execute(self, path: str, encoding: str = "utf-8"):
        """
        è¯»å–æ–‡ä»¶å†…å®¹
        
        å‚æ•°ï¼š
            path (str): æ–‡ä»¶è·¯å¾„
            encoding (str): æ–‡ä»¶ç¼–ç 
        
        è¿”å›ï¼š
            Dict: æ–‡ä»¶å†…å®¹å’Œå…ƒä¿¡æ¯
        """
        # å®‰å…¨æ£€æŸ¥1ï¼šè·¯å¾„éå†æ”»å‡»
        if '..' in path or path.startswith('/') or path.startswith('\\'):
            raise ToolExecutionError(
                "ä¸å®‰å…¨çš„æ–‡ä»¶è·¯å¾„ï¼šä¸å…è®¸è®¿é—®çˆ¶ç›®å½•æˆ–ç»å¯¹è·¯å¾„",
                tool_name=self.name,
                details={"path": path}
            )
        
        # æ„å»ºå®Œæ•´è·¯å¾„
        full_path = self.project_root / path
        
        # å®‰å…¨æ£€æŸ¥2ï¼šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not full_path.exists():
            raise ToolExecutionError(
                f"æ–‡ä»¶ä¸å­˜åœ¨: {path}",
                tool_name=self.name,
                details={"path": str(full_path)}
            )
        
        # å®‰å…¨æ£€æŸ¥3ï¼šæ–‡ä»¶å¤§å°
        file_size = full_path.stat().st_size
        if file_size > self.max_file_size:
            raise ToolExecutionError(
                f"æ–‡ä»¶è¿‡å¤§: {file_size / 1024 / 1024:.2f}MBï¼ˆæœ€å¤§10MBï¼‰",
                tool_name=self.name,
                details={"path": path, "size": file_size}
            )
        
        # è¯»å–æ–‡ä»¶
        try:
            with open(full_path, 'r', encoding=encoding) as f:
                content = f.read()
            
            logger.info(
                "æ–‡ä»¶è¯»å–æˆåŠŸ",
                path=path,
                size=len(content),
                encoding=encoding
            )
            
            return {
                "success": True,
                "data": content,
                "path": path,
                "size": len(content),
                "message": f"æˆåŠŸè¯»å–æ–‡ä»¶ {path}ï¼ˆ{len(content)} å­—ç¬¦ï¼‰"
            }
            
        except UnicodeDecodeError:
            raise ToolExecutionError(
                f"æ–‡ä»¶ç¼–ç é”™è¯¯ï¼Œè¯·å°è¯•å…¶ä»–ç¼–ç ï¼ˆå½“å‰ï¼š{encoding}ï¼‰",
                tool_name=self.name,
                details={"path": path, "encoding": encoding}
            )
```

---

### æ­¥éª¤2ï¼šæ³¨å†Œå·¥å…·

**æ–¹æ³•1ï¼šåœ¨ chat.py ä¸­æ³¨å†Œ**ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰ï¼š

```python
# app/api/v1/chat.py

from app.tools.file.file_read_tool import FileReadTool

# åœ¨è·¯ç”±å®šä¹‰ä¹‹å‰
try:
    tool_manager.register_tool(MySQLQueryTool())
    tool_manager.register_tool(FileReadTool())  # â† æ·»åŠ è¿™è¡Œ
    logger.info("å·¥å…·æ³¨å†Œå®Œæˆ", tool_count=len(tool_manager))
except Exception as e:
    logger.warning("å·¥å…·æ³¨å†Œå¤±è´¥", error=str(e))
```

**æ–¹æ³•2ï¼šåˆ›å»ºå·¥å…·æ³¨å†Œä¸­å¿ƒ**ï¼ˆæ¨èï¼Œæ›´æ¸…æ™°ï¼‰ï¼š

```python
# app/tools/registry.py

"""å·¥å…·æ³¨å†Œä¸­å¿ƒ"""

from app.tools.manager import tool_manager
from app.tools.database.mysql_tool import MySQLQueryTool
from app.tools.file.file_read_tool import FileReadTool
from app.tools.system.powershell_tool import PowerShellTool
from app.utils.logger import get_logger

logger = get_logger(__name__)


def register_all_tools():
    """
    æ³¨å†Œæ‰€æœ‰å¯ç”¨å·¥å…·
    
    åœ¨è¿™é‡Œæ·»åŠ æ–°å·¥å…·ï¼
    """
    tools = [
        # æ•°æ®åº“å·¥å…·
        MySQLQueryTool(),
        
        # æ–‡ä»¶å·¥å…·
        FileReadTool(),
        
        # ç³»ç»Ÿå·¥å…·
        # PowerShellTool(),  # æš‚æ—¶æ³¨é‡Šï¼Œæœªå®ç°
        
        # Web å·¥å…·
        # HTTPTool(),  # æš‚æ—¶æ³¨é‡Šï¼Œæœªå®ç°
    ]
    
    for tool in tools:
        try:
            tool_manager.register_tool(tool)
            logger.info(f"âœ“ {tool.name} æ³¨å†ŒæˆåŠŸ")
        except Exception as e:
            logger.warning(f"âœ— {tool.name} æ³¨å†Œå¤±è´¥: {str(e)}")
    
    logger.info(f"å·¥å…·æ³¨å†Œå®Œæˆï¼Œå…± {len(tool_manager)} ä¸ªå·¥å…·")
    return tool_manager


# ç„¶ååœ¨ chat.py ä¸­ï¼š
# from app.tools.registry import register_all_tools
# register_all_tools()
```

---

### æ­¥éª¤3ï¼šæµ‹è¯•å·¥å…·

**åˆ›å»ºæµ‹è¯•è„šæœ¬**ï¼š`scripts/test_file_tool.py`

```python
import sys
import io
from pathlib import Path

# è®¾ç½®ç¼–ç 
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from app.tools.file.file_read_tool import FileReadTool


def main():
    print("\n========== æµ‹è¯•æ–‡ä»¶è¯»å–å·¥å…· ==========\n")
    
    tool = FileReadTool()
    
    # æµ‹è¯•1ï¼šè¯»å– README.md
    print("æµ‹è¯•1: è¯»å– README.md")
    result = tool.execute(path="README.md")
    print(f"  âœ“ è¯»å–æˆåŠŸ: {result['size']} å­—ç¬¦")
    
    # æµ‹è¯•2ï¼šä¸å®‰å…¨è·¯å¾„ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    print("\næµ‹è¯•2: æµ‹è¯•å®‰å…¨æ£€æŸ¥ï¼ˆåº”è¯¥å¤±è´¥ï¼‰")
    try:
        tool.execute(path="../../../etc/passwd")
        print("  âœ— å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼šä¸åº”è¯¥å…è®¸è®¿é—®")
    except Exception as e:
        print(f"  âœ“ å®‰å…¨æ£€æŸ¥é€šè¿‡: {str(e)[:50]}...")
    
    print("\nâœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼\n")


if __name__ == "__main__":
    main()
```

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
python scripts/test_file_tool.py
```

---

### æ­¥éª¤4ï¼šé‡å¯æœåŠ¡å¹¶ä½¿ç”¨

```bash
# å¦‚æœæ˜¯ reload æ¨¡å¼ï¼Œä¼šè‡ªåŠ¨é‡å¯
# å¦åˆ™æ‰‹åŠ¨é‡å¯ï¼š
python scripts/run_dev.py
```

**åœ¨å¯¹è¯ä¸­ä½¿ç”¨**ï¼š
```
ç”¨æˆ·: è¯·å¸®æˆ‘è¯»å– README.md æ–‡ä»¶çš„å†…å®¹
Agent: (è‡ªåŠ¨è°ƒç”¨ file_read å·¥å…·ï¼Œè¿”å›æ–‡ä»¶å†…å®¹)
```

---

## ğŸ›¡ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. è·¯å¾„å®‰å…¨

```python
# âœ… å®‰å…¨çš„è·¯å¾„æ£€æŸ¥
if '..' in path or path.startswith('/'):
    raise ToolExecutionError("ä¸å®‰å…¨çš„è·¯å¾„")

# âœ… é™åˆ¶åœ¨é¡¹ç›®ç›®å½•å†…
full_path = project_root / path
if not full_path.is_relative_to(project_root):
    raise ToolExecutionError("è·¯å¾„è¶…å‡ºé¡¹ç›®èŒƒå›´")
```

### 2. PowerShell/å‘½ä»¤æ‰§è¡Œå®‰å…¨

```python
# âœ… ç™½åå•æœºåˆ¶
ALLOWED_COMMANDS = ['ls', 'dir', 'echo', 'date']

if command.split()[0] not in ALLOWED_COMMANDS:
    raise ToolExecutionError("ä¸å…è®¸çš„å‘½ä»¤")

# âœ… å‚æ•°è¿‡æ»¤
if any(char in command for char in [';', '&', '|', '>', '<']):
    raise ToolExecutionError("ä¸å…è®¸çš„å­—ç¬¦")
```

### 3. SQL æ³¨å…¥é˜²æŠ¤

```python
# âœ… ä»…å…è®¸ SELECT
if not query.lower().strip().startswith('select'):
    raise ToolExecutionError("ä»…æ”¯æŒ SELECT æŸ¥è¯¢")

# âœ… ç¦æ­¢å±é™©å…³é”®å­—
dangerous = ['drop', 'delete', 'update', 'insert']
if any(kw in query.lower() for kw in dangerous):
    raise ToolExecutionError("ä¸å…è®¸çš„ SQL å…³é”®å­—")
```

### 4. èµ„æºé™åˆ¶

```python
# âœ… é™åˆ¶è¿”å›æ•°æ®é‡
result = cursor.fetchmany(1000)  # æœ€å¤š1000è¡Œ

# âœ… é™åˆ¶æ–‡ä»¶å¤§å°
if file_size > 10 * 1024 * 1024:  # 10MB
    raise ToolExecutionError("æ–‡ä»¶è¿‡å¤§")

# âœ… é™åˆ¶æ‰§è¡Œæ—¶é—´
import signal
signal.alarm(30)  # 30ç§’è¶…æ—¶
```

---

## ğŸ“š å‚è€ƒç¤ºä¾‹

### ç¤ºä¾‹1ï¼šHTTP è¯·æ±‚å·¥å…·

```python
# app/tools/web/http_tool.py

import requests
from pydantic import Field

class HTTPInput(ToolInput):
    url: str = Field(..., description="è¯·æ±‚çš„ URL")
    method: str = Field(default="GET", description="HTTP æ–¹æ³•")

class HTTPTool(AgentTool):
    name: str = "http_request"
    description: str = "å‘é€ HTTP è¯·æ±‚è·å–æ•°æ®"
    args_schema: Type[BaseModel] = HTTPInput
    
    def execute(self, url: str, method: str = "GET"):
        # å®‰å…¨æ£€æŸ¥ï¼šä»…å…è®¸ HTTP/HTTPS
        if not url.startswith(('http://', 'https://')):
            raise ToolExecutionError("ä»…æ”¯æŒ HTTP/HTTPS")
        
        response = requests.request(method, url, timeout=10)
        return {
            "success": True,
            "data": response.text,
            "status_code": response.status_code
        }
```

### ç¤ºä¾‹2ï¼šPowerShell å·¥å…·

```python
# app/tools/system/powershell_tool.py

import subprocess

class PowerShellInput(ToolInput):
    command: str = Field(..., description="PowerShell å‘½ä»¤")

class PowerShellTool(AgentTool):
    name: str = "powershell"
    description: str = "æ‰§è¡Œå®‰å…¨çš„ PowerShell å‘½ä»¤"
    args_schema: Type[BaseModel] = PowerShellInput
    
    # ç™½åå•
    ALLOWED_COMMANDS = ['Get-Date', 'Get-Location', 'Get-ChildItem']
    
    def execute(self, command: str):
        # å®‰å…¨æ£€æŸ¥
        cmd_name = command.split()[0]
        if cmd_name not in self.ALLOWED_COMMANDS:
            raise ToolExecutionError(f"ä¸å…è®¸çš„å‘½ä»¤: {cmd_name}")
        
        result = subprocess.run(
            ['pwsh', '-Command', command],
            capture_output=True,
            text=True,
            timeout=10
        )
        
        return {
            "success": True,
            "data": result.stdout,
            "error": result.stderr
        }
```

---

## ğŸ¯ æ·»åŠ å·¥å…· Checklist

- [ ] 1. åˆ›å»ºå·¥å…·æ–‡ä»¶ï¼ˆapp/tools/åˆ†ç±»/xxx_tool.pyï¼‰
- [ ] 2. å®šä¹‰ Input ç±»ï¼ˆå‚æ•° Schemaï¼‰
- [ ] 3. ç»§æ‰¿ AgentTool å¹¶è®¾ç½® nameã€descriptionã€args_schema
- [ ] 4. å®ç° execute() æ–¹æ³•
- [ ] 5. æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼ˆè·¯å¾„ã€å¤§å°ã€ç™½åå•ç­‰ï¼‰
- [ ] 6. æ³¨å†Œå·¥å…·ï¼ˆchat.py æˆ– registry.pyï¼‰
- [ ] 7. åˆ›å»ºæµ‹è¯•è„šæœ¬
- [ ] 8. è¿è¡Œæµ‹è¯•éªŒè¯
- [ ] 9. é‡å¯æœåŠ¡
- [ ] 10. åœ¨å¯¹è¯ä¸­æµ‹è¯•

---

## ğŸ’¡ æç¤º

1. **å‚è€ƒç°æœ‰å·¥å…·**ï¼š`app/tools/database/mysql_tool.py` æ˜¯æœ€å¥½çš„å‚è€ƒ
2. **å®‰å…¨ç¬¬ä¸€**ï¼šæ‰€æœ‰å¤–éƒ¨è¾“å…¥éƒ½è¦éªŒè¯
3. **è¯¦ç»†çš„æè¿°**ï¼šå¸®åŠ© Agent æ­£ç¡®é€‰æ‹©å·¥å…·
4. **ç»Ÿä¸€çš„è¿”å›æ ¼å¼**ï¼šä¾¿äº Agent ç†è§£ç»“æœ
5. **å®Œæ•´çš„æµ‹è¯•**ï¼šç¡®ä¿å·¥å…·ç¨³å®šå¯é 

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- å·¥å…·åŸºç±»ï¼š`app/tools/base.py`
- å·¥å…·ç®¡ç†å™¨ï¼š`app/tools/manager.py`
- MySQL å·¥å…·ç¤ºä¾‹ï¼š`app/tools/database/mysql_tool.py`
- æ³¨å†Œä½ç½®ï¼š`app/api/v1/chat.py`ï¼ˆç¬¬31-37è¡Œï¼‰

---

**æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ï¼** ğŸ˜Š


