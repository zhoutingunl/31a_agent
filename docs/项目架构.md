# Agent 项目架构

> 基于 FastAPI + LangGraph + MCP 的智能 Agent 系统

## 核心架构

```
客户端 (Web/API)
    ↓
FastAPI (路由 + 中间件)
    ↓
RoleService (角色服务)
    ↓
Orchestrator (智能编排器)
    ├─ TaskRouter (任务路由器)
    ├─ StateMachine (状态机)
    └─ ErrorHandler (异常处理)
    ↓
Agent 系统
    ├─ PlannerAgent (规划代理)
    ├─ ExecutorAgent (执行代理)
    ├─ ToolAgent (工具代理)
    └─ SimpleAgent (简单代理)
    ↓
核心服务
    ├─ MemoryService (记忆管理)
    ├─ KnowledgeService (知识图谱)
    ├─ ReflectionService (反思服务)
    └─ PlanningService (规划服务)
    ↓
DAO (数据访问)
    ↓
MySQL + FAISS (持久化存储 + 向量检索)
```

---

## 实际目录结构

```
app/                              # 应用主目录
├── main.py                       # FastAPI 入口
├── api/v1/                       # API 路由
│   ├── chat.py                   # 对话接口（流式/非流式）
│   ├── conversation.py           # 会话管理
│   ├── message.py                # 消息查询
│   ├── health.py                 # 健康检查
│   ├── general.py                # 通用角色API
│   ├── customer_service.py       # 客服角色API
│   ├── reflection.py             # 反思API
│   └── deps.py                   # 依赖注入
├── core/                         # 核心功能
│   ├── agent/                    # Agent 实现
│   │   ├── base.py              # Agent 基类
│   │   ├── simple_agent.py      # 简单对话
│   │   ├── tool_agent.py        # LangGraph 工具 Agent
│   │   ├── planner_agent.py     # 规划代理
│   │   └── executor_agent.py    # 执行代理
│   ├── orchestrator/             # 智能编排器
│   │   ├── orchestrator.py      # 编排器核心
│   │   ├── router.py            # 任务路由器
│   │   ├── state_machine.py     # 状态机
│   │   ├── error_handler.py     # 异常处理
│   │   └── schemas.py           # 编排器模式
│   ├── memory/                   # 记忆管理
│   │   ├── memory_manager.py    # 记忆管理器
│   │   ├── memory_classifier.py # 记忆分类器
│   │   ├── importance_scorer.py # 重要性评分器
│   │   ├── memory_compressor.py # 记忆压缩器
│   │   ├── forgetting_mechanism.py # 遗忘机制
│   │   ├── context_builder.py   # 上下文构建
│   │   └── hybrid_retriever.py  # 混合检索器
│   ├── knowledge/                # 知识图谱
│   │   ├── knowledge_graph_manager.py # 知识图谱管理器
│   │   ├── entity_extractor.py  # 实体提取器
│   │   ├── relation_extractor.py # 关系提取器
│   │   ├── memory_upgrader.py   # 记忆升级器
│   │   └── graph_reasoner.py    # 图谱推理器
│   ├── planning/                 # 任务规划
│   │   ├── task_decomposer.py   # 任务分解器
│   │   ├── workflow_engine.py   # 工作流引擎
│   │   ├── loop_executor.py     # 循环执行器
│   │   ├── parallel_executor.py # 并行执行器
│   │   ├── dynamic_planner.py   # 动态规划器
│   │   └── schemas.py           # 规划模式
│   ├── reflection/               # 反思系统
│   │   ├── quality_scorer.py    # 质量评分器
│   │   ├── critic.py            # 批评者
│   │   ├── self_corrector.py    # 自我纠错器
│   │   └── schemas.py           # 反思模式
│   ├── roles/                    # 角色管理
│   │   ├── role_config.py       # 角色配置
│   │   ├── role_manager.py      # 角色管理器
│   │   ├── general.yaml         # 通用角色配置
│   │   └── customer_service.yaml # 客服角色配置
│   ├── embedding/                # 向量化
│   │   ├── embedding_service.py # 向量化服务
│   │   ├── sentence_transformer.py # 句子转换器
│   │   └── embedding_cache.py   # 向量缓存
│   ├── vectordb/                 # 向量数据库
│   │   ├── memory_vector_store.py # 记忆向量存储
│   │   ├── faiss_persister.py   # FAISS持久化
│   │   ├── metadata_manager.py  # 元数据管理
│   │   └── faiss_index.py       # FAISS索引
│   ├── llm/                      # LLM 适配
│   │   ├── base.py              # LLM 基类
│   │   ├── deepseek.py          # DeepSeek 实现
│   │   └── factory.py           # LLM 工厂
│   └── mcp/                      # MCP 集成
│       ├── client.py            # MCP 客户端
│       ├── manager.py           # MCP 管理器
│       └── loader.py            # 配置加载
├── tools/                        # 工具系统
│   ├── base.py                   # 工具基类
│   ├── manager.py                # 工具管理器
│   ├── registry.py               # 统一注册中心
│   ├── database/
│   │   └── mysql_tool.py        # MySQL 工具
│   └── mcp/
│       └── wrapper.py           # MCP 工具包装器
├── services/                     # 业务逻辑
│   ├── conversation_service.py
│   ├── message_service.py
│   ├── memory_service.py         # 记忆服务
│   ├── knowledge_service.py      # 知识服务
│   ├── planning_service.py       # 规划服务
│   ├── reflection_service.py     # 反思服务
│   └── role_service.py           # 角色服务
├── dao/                          # 数据访问
│   ├── base.py                   # DAO 基类
│   ├── conversation_dao.py
│   ├── message_dao.py
│   ├── user_dao.py
│   ├── memory_dao.py             # 记忆DAO
│   ├── knowledge_dao.py          # 知识DAO
│   └── task_dao.py               # 任务DAO
├── models/                       # ORM 模型
│   ├── database.py               # 数据库连接
│   ├── base.py                   # 基类
│   ├── user.py
│   ├── conversation.py
│   ├── message.py
│   ├── memory.py                 # 记忆模型
│   ├── knowledge.py              # 知识模型
│   └── task.py                   # 任务模型
├── schemas/                      # Pydantic 模式
│   ├── base.py
│   ├── conversation.py
│   ├── message.py
│   ├── memory.py                 # 记忆模式
│   ├── knowledge.py              # 知识模式
│   └── task.py                   # 任务模式
├── middleware/                   # 中间件
│   ├── logging_middleware.py
│   └── error_handler.py
└── utils/                        # 工具函数
    ├── logger.py                 # 统一日志
    ├── config.py                 # 配置管理
    ├── exceptions.py             # 自定义异常
    └── helpers.py

config/                           # 配置文件
├── config.yaml
├── config.example.yaml
├── faiss_gpu_config.yaml.example
└── prompts/
    └── system.txt

docs/                             # 文档
├── api/                          # API文档
├── deployment/                   # 部署文档
├── developer/                    # 开发者文档
├── memory/                       # 记忆系统文档
├── plan/                         # 阶段总结
├── 项目架构.md
├── 开发规范.md
├── 数据库设计.md
├── 添加新工具指南.md
└── MCP快速开始指南.md

tests/                            # 测试
├── unit/                         # 单元测试
├── integration/                  # 集成测试
├── e2e/                          # 端到端测试
└── performance/                  # 性能测试

scripts/                          # 脚本
├── init_db.py
├── init_agent_db.py
└── run_dev.py

docker/                           # Docker配置
├── entrypoint.sh
└── README.md

web/                              # 前端
├── static/{css,js}/
└── templates/chat.html

mcp.json                          # MCP 配置
mcp.json.example                  # MCP 模板
.env                              # 环境变量
requirements.txt
Dockerfile                        # Docker镜像
docker-compose.yml                # Docker编排
```

---

## 关键组件

### 智能编排器 (Orchestrator)
- **Orchestrator** (`app/core/orchestrator/orchestrator.py`): 统一编排器，协调多个Agent
- **TaskRouter** (`app/core/orchestrator/router.py`): 智能任务路由器，决定执行模式
- **StateMachine** (`app/core/orchestrator/state_machine.py`): 状态机管理
- **ErrorHandler** (`app/core/orchestrator/error_handler.py`): 异常处理和恢复

### Agent 系统
- **PlannerAgent** (`app/core/agent/planner_agent.py`): 规划代理，负责任务分解和规划
- **ExecutorAgent** (`app/core/agent/executor_agent.py`): 执行代理，负责任务执行
- **ToolAgent** (`app/core/agent/tool_agent.py`): 工具代理，LangGraph实现工具调用
- **SimpleAgent** (`app/core/agent/simple_agent.py`): 简单对话代理

### 记忆管理系统
- **MemoryService** (`app/services/memory_service.py`): 记忆管理服务
- **MemoryManager** (`app/core/memory/memory_manager.py`): 记忆管理器
- **HybridRetriever** (`app/core/memory/hybrid_retriever.py`): 混合检索器
- **MemoryVectorStore** (`app/core/vectordb/memory_vector_store.py`): FAISS向量存储

### 知识图谱系统
- **KnowledgeService** (`app/services/knowledge_service.py`): 知识图谱服务
- **KnowledgeGraphManager** (`app/core/knowledge/knowledge_graph_manager.py`): 知识图谱管理器
- **EntityExtractor** (`app/core/knowledge/entity_extractor.py`): 实体提取器
- **GraphReasoner** (`app/core/knowledge/graph_reasoner.py`): 图谱推理器

### 任务规划系统
- **PlanningService** (`app/services/planning_service.py`): 规划服务
- **TaskDecomposer** (`app/core/planning/task_decomposer.py`): 任务分解器
- **WorkflowEngine** (`app/core/planning/workflow_engine.py`): 工作流引擎
- **DynamicPlanner** (`app/core/planning/dynamic_planner.py`): 动态规划器

### 反思系统
- **ReflectionService** (`app/services/reflection_service.py`): 反思服务
- **QualityScorer** (`app/core/reflection/quality_scorer.py`): 质量评分器
- **SelfCorrector** (`app/core/reflection/self_corrector.py`): 自我纠错器

### 角色管理系统
- **RoleService** (`app/services/role_service.py`): 角色服务
- **RoleManager** (`app/core/roles/role_manager.py`): 角色管理器
- **RoleConfig** (`app/core/roles/role_config.py`): 角色配置管理

### 工具系统
- **ToolManager** (`app/tools/manager.py`): 管理所有工具
- **自定义工具**: 继承 `AgentTool`，定义 `name`, `description`, `args_schema`, `execute()`
- **MCP 工具**: 通过 `mcp.json` 配置，自动包装

### 数据流
```
用户消息 → RoleService → Orchestrator → Agent系统 → 核心服务 → 响应
                ↓              ↓           ↓          ↓
            角色配置      智能路由    记忆/知识    流式输出
```

---

## 核心代码模式

### 日志（必须使用）
```python
from app.utils.logger import get_logger
logger = get_logger(__name__)
logger.info("操作", key=value)  # 禁止 print()
```

### 配置读取
```python
from app.utils.config import config
db_host = config.get("database.mysql.host")
```

### 数据库依赖
```python
from app.api.deps import get_database
def func(db: Session = Depends(get_database)): ...
```

### 异常抛出
```python
from app.utils.exceptions import DatabaseError, ToolExecutionError
raise ToolExecutionError("失败", tool_name="xxx", details={...})
```

### 工具定义
```python
from app.tools.base import AgentTool
class MyTool(AgentTool):
    name: str = "tool_name"
    description: str = "详细描述"
    args_schema: Type[BaseModel] = MyInput
    def execute(self, **kwargs): ...
```

---

## 重要约定

### 代码分层
- **API 层**: 仅处理 HTTP，调用 Service
- **Service 层**: 业务逻辑，调用 DAO
- **DAO 层**: 数据库操作，继承 BaseDAO
- **Model 层**: SQLAlchemy ORM，继承 TimestampMixin

### 命名规范
- 文件: snake_case (`mysql_tool.py`)
- 类: PascalCase (`MySQLTool`)
- 函数/变量: snake_case (`get_user_by_id`)
- 工具名: snake_case (`mysql_query`)

### 导入顺序
1. Python 标准库
2. 第三方库
3. 本地模块（绝对导入 `from app.xxx import yyy`）

### MCP 配置
- 位置: 项目根目录 `mcp.json`
- 格式: `{"mcpServers": {"name": {"command": "npx", "args": [...]}}}`
- 自动加载: `register_all_tools(enable_mcp=True)` 自动发现并包装工具

---

## 技术栈

### 核心框架
- **FastAPI**: Web框架和API服务
- **SQLAlchemy 2.0**: ORM数据库操作
- **Pydantic**: 数据验证和序列化
- **LangGraph**: Agent框架和工具调用

### AI和机器学习
- **DeepSeek API**: 大语言模型服务
- **SentenceTransformer**: 文本向量化
- **FAISS**: 向量检索和相似度搜索
- **NetworkX**: 知识图谱分析

### 数据库和存储
- **MySQL**: 关系型数据库
- **FAISS**: 向量数据库
- **SQLite**: 测试数据库

### 工具和集成
- **MCP (Model Context Protocol)**: 外部工具集成
- **Docker**: 容器化部署
- **pytest**: 测试框架

### 开发工具
- **colorlog**: 彩色日志
- **httpx**: HTTP客户端
- **asyncio**: 异步编程

